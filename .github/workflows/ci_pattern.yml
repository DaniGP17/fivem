name: CI Pattern Check

on:
  workflow_dispatch:
    inputs:
      run_pattern_check:
        description: "Run only the pattern check"
        required: true
        default: "true"
      patterns:
        description: "Pattern list to validate (splitted by commas)"
        required: true
        type: string
        default: 83 CE ? 44 8B C6 44 8A CD,4C 8D 9C 24 ? ? ? ? 49 8B 5B ? 49 8B 73 ? 41 0F 28 73 ? 41 0F 28 7B ? 45 0F 28 43 ? 49 8B E3 41 5E 41 5D
      game:
        description: "Game (fivem, redm, both, none)"
        required: true
        type: string
  workflow_call:
    inputs:
      patterns:
        description: "Pattern list to validate (splitted by commas)"
        required: true
        type: string
      game:
        description: "Game (fivem, redm, both, none)"
        required: true
        type: string

permissions:
  packages: read

jobs:
  pattern_check:
    name: Pre-build Pattern Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone PatternV
        run: git clone --depth 1 https://github.com/DaniGP17/PatternV.git

      - name: Build PatternV
        run: |
          cd PatternV
          mkdir build && cd build
          cmake ..
          make -j$(nproc)

      - name: Download .text files
        run: |
          BASE_URL="https://raw.githubusercontent.com/DaniGP17/fivem/feat/ci-pattern-check/builds"

          # Decidir builds y prefijo seg√∫n el juego
          case "${{ inputs.game }}" in
            fivem)
              BUILDS=(1491)
              PREFIX="GTA5"
              ;;
            redm)
              BUILDS=(1491)
              PREFIX="RDR2"
              ;;
            both)
              # Para both, descargamos cada set con su prefijo
              echo "Downloading FiveM builds..."
              mkdir -p Release/Builds
              cd Release/Builds
              for build in 1491; do
                FILE="GTA5-${build}.text"
                echo "Downloading $FILE..."
                curl -f -L -o "$FILE" "$BASE_URL/$FILE" || { echo "Error downloading $FILE"; exit 1; }
              done
              echo "Downloading RedM builds..."
              for build in 1604 2060 2189 2372 2545 2612 2699 2802 2944 3095 3258 3323 3407 3570; do
                FILE="RDR2-${build}.text"
                echo "Downloading $FILE..."
                curl -f -L -o "$FILE" "$BASE_URL/$FILE" || { echo "Error downloading $FILE"; exit 1; }
              done
              exit 0
              ;;
            none)
              echo "No game selected, skipping download."
              exit 0
              ;;
            *)
              echo "Unknown game value: ${{ inputs.game }}"
              exit 1
              ;;
          esac
          
          mkdir -p Release/Builds
          cd Release/Builds
          
          for build in "${BUILDS[@]}"; do
            FILE="${PREFIX}-${build}.text"
            echo "Downloading $FILE..."
            curl -f -L -o "$FILE" "$BASE_URL/$FILE" || { echo "Error downloading $FILE"; exit 1; }
          done

      - name: Run PatternV
        run: |
          PATTERNS_RAW="${{ inputs.patterns }}"
          PATTERNS_CLEAN=$(echo "$PATTERNS_RAW" | tr ',' '\n' | sed '/^\s*$/d')
          FAIL=0

          while IFS= read -r pattern; do
            echo "Searching pattern: $pattern"
            timeout 60s ./PatternV/build/PatternV Release/Builds "$pattern" || FAIL=2
          done <<< "$PATTERNS_CLEAN"

          exit $FAIL