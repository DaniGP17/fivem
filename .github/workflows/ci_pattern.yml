name: CI Pattern Check

on:
  workflow_call:
    inputs:
      patterns:
        description: "Pattern list to validate (splitted by commas)"
        required: true
        type: string
      game:
        description: "Game (fivem, redm, both, none)"
        required: true
        type: string

permissions:
  packages: read
  contents: read
  pull-requests: write

jobs:
  pattern_check:
    name: Pre-build Pattern Check
    runs-on: ubuntu-latest
    steps:
      - name: Clone PatternV
        run: git clone --depth 1 https://github.com/DaniGP17/PatternV.git

      - name: Cache PatternV build
        uses: actions/cache@v4
        with:
          path: PatternV/build
          key: patternv-${{ hashFiles('PatternV/CMakeLists.txt') }}

      - name: Build PatternV
        run: |
          cd PatternV
          mkdir -p build && cd build
          cmake ..
          make -j$(nproc)

      - name: Download .text files
        run: |
          BASE_URL="https://raw.githubusercontent.com/DaniGP17/fivem/feat/ci-pattern-check/builds"

          BUILDS_FIVEM=(1604 2060 2189 2372 2545 2612 2699 2802 2944 3095 3258 3323 3407 3570)
          BUILDS_REDM=(1491)

          mkdir -p Release/Builds
          cd Release/Builds

          download_builds() {
            local prefix="$1"
            shift
            local builds=("$@")

            export BASE_URL
            export prefix

            printf "%s\n" "${builds[@]}" | xargs -n1 -P"$(nproc)" bash -c '
              build="$1"
              FILE="${prefix}-${build}.text"
              echo "Downloading $FILE..."
              curl -sSfL --retry 3 -o "$FILE" "$BASE_URL/$FILE" || { echo "Error downloading $FILE"; exit 1; }
            ' _
          }

          case "${{ inputs.game }}" in
            fivem)
              download_builds "GTA5" "${BUILDS_FIVEM[@]}"
              ;;
            redm)
              download_builds "RDR2" "${BUILDS_REDM[@]}"
              ;;
            both)
              echo "Downloading RedM builds..."
              download_builds "RDR2" "${BUILDS_REDM[@]}"
              echo "Downloading FiveM builds..."
              download_builds "GTA5" "${BUILDS_FIVEM[@]}"
              ;;
            none)
              echo "No game selected, skipping download."
              exit 0
              ;;
            *)
              echo "Unknown game value: ${{ inputs.game }}"
              exit 1
              ;;
          esac

      - name: Run PatternV
        id: run_patternv
        run: |
          PATTERNS_RAW="${{ inputs.patterns }}"
          PATTERNS_CLEAN=$(echo "$PATTERNS_RAW" | tr ',' '\n' | sed '/^\s*$/d')
          OUTPUT=""
          FAIL=0

          while IFS= read -r pattern; do
            echo "Searching pattern: $pattern"
            RESULT=$(timeout 60s ./PatternV/build/PatternV Release/Builds "$pattern" --no-color 2>&1 | \
              sed 's/\(\[\+\|\[-\)\([^]]*\]\)/\n\1\2/g' | \
              sed -E 's/^\[\+\]/- [x]/; s/^\[-\]/- [ ]/') || FAIL=2
            OUTPUT="$OUTPUT\n#### Pattern: $pattern\n\n$RESULT\n"

          done <<< "$PATTERNS_CLEAN"

          ENCODED=$(echo -e "$OUTPUT" | base64 -w0)
          echo "output_b64=$ENCODED" >> $GITHUB_OUTPUT
      
      - name: Comment results on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const decoded = Buffer.from(`${{ steps.run_patternv.outputs.output_b64 }}`, 'base64').toString();
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: decoded
            });